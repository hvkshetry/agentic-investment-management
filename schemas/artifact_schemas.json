{
  "artifact_base": {
    "type": "object",
    "required": ["id", "kind", "schema_version", "created_at", "created_by", "provenance", "payload"],
    "properties": {
      "id": {"type": "string", "format": "uuid"},
      "kind": {"type": "string", "enum": [
        "portfolio_snapshot",
        "macro_context", 
        "equity_analysis",
        "risk_analysis",
        "optimization_candidate",
        "tax_impact",
        "trade_list",
        "gate_validation",
        "halt_order",
        "ic_memo"
      ]},
      "schema_version": {"type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$"},
      "created_at": {"type": "string", "format": "date-time"},
      "created_by": {"type": "string"},
      "depends_on": {"type": "array", "items": {"type": "string"}},
      "confidence": {"type": "number", "minimum": 0, "maximum": 1},
      "provenance": {
        "type": "object",
        "required": ["tool_calls", "data_quality"],
        "properties": {
          "tool_calls": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["id", "name", "args", "timestamp"],
              "properties": {
                "id": {"type": "string"},
                "name": {"type": "string"},
                "args": {"type": "object"},
                "timestamp": {"type": "string", "format": "date-time"},
                "output_digest": {"type": "string", "pattern": "^sha256:"}
              }
            }
          },
          "data_quality": {
            "type": "object",
            "properties": {
              "missing_prices": {"type": "integer", "minimum": 0},
              "missing_holdings": {"type": "integer", "minimum": 0},
              "lots_enriched": {"type": "boolean"},
              "stale_data": {"type": "boolean"},
              "needs": {"type": "array", "items": {"type": "string"}}
            }
          }
        }
      },
      "payload": {"type": "object"}
    }
  },
  
  "risk_analysis": {
    "allOf": [{"$ref": "#/artifact_base"}],
    "properties": {
      "kind": {"const": "risk_analysis"},
      "payload": {
        "type": "object",
        "required": ["portfolio_analyzed", "risk_metrics", "halt_status", "concentration_analysis"],
        "properties": {
          "portfolio_analyzed": {
            "type": "object",
            "required": ["positions_count", "portfolio_value", "using_portfolio_state"],
            "properties": {
              "positions_count": {"type": "integer", "minimum": 1},
              "portfolio_value": {"type": "number", "minimum": 0},
              "using_portfolio_state": {"type": "boolean"}
            }
          },
          "risk_metrics": {
            "type": "object",
            "required": ["es_975_1day", "es_limit", "es_utilization", "status"],
            "properties": {
              "es_975_1day": {"type": "number"},
              "es_limit": {"type": "number", "const": 0.025},
              "es_utilization": {"type": "number", "minimum": 0},
              "var_95_1day": {"type": "number"},
              "es_var_ratio": {"type": "number"},
              "sharpe_ratio": {"type": "number"},
              "max_drawdown": {"type": "number"},
              "component_es": {"type": "object"},
              "status": {"type": "string", "enum": ["actual", "derived", "estimate"]}
            }
          },
          "concentration_analysis": {
            "type": "object",
            "required": ["funds_exempt", "max_underlying_company", "max_underlying_weight", "violations"],
            "properties": {
              "funds_exempt": {"type": "boolean", "const": true},
              "max_underlying_company": {"type": "string"},
              "max_underlying_weight": {"type": "number", "minimum": 0, "maximum": 1},
              "violations": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["ticker", "weight", "type"],
                  "properties": {
                    "ticker": {"type": "string"},
                    "weight": {"type": "number"},
                    "type": {"type": "string", "enum": ["individual_stock", "fund"]}
                  }
                }
              }
            }
          },
          "halt_status": {
            "type": "object",
            "required": ["halt_required", "es_breach", "liquidity_breach", "concentration_breach"],
            "properties": {
              "halt_required": {"type": "boolean"},
              "es_breach": {"type": "boolean"},
              "liquidity_breach": {"type": "boolean"},
              "concentration_breach": {"type": "boolean"},
              "reasons": {"type": "array", "items": {"type": "string"}}
            }
          }
        }
      }
    }
  },
  
  "tax_impact": {
    "allOf": [{"$ref": "#/artifact_base"}],
    "properties": {
      "kind": {"const": "tax_impact"},
      "payload": {
        "type": "object",
        "required": ["analysis", "recommendations", "status"],
        "properties": {
          "analysis": {
            "type": "object",
            "required": ["total_tax", "breakdown", "effective_rate", "status"],
            "properties": {
              "total_tax": {"type": "number"},
              "breakdown": {
                "type": "object",
                "properties": {
                  "federal": {"type": "number"},
                  "state": {"type": "number"},
                  "niit": {"type": "number"},
                  "amt": {"type": "number"}
                }
              },
              "effective_rate": {"type": "number", "minimum": 0, "maximum": 1},
              "marginal_rate": {"type": "number", "minimum": 0, "maximum": 1},
              "optimization_available": {"type": "number"},
              "status": {"type": "string", "enum": ["actual", "derived", "estimate"]}
            }
          },
          "harvesting_opportunities": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["symbol", "loss", "tax_benefit", "status"],
              "properties": {
                "symbol": {"type": "string"},
                "loss": {"type": "number"},
                "tax_benefit": {"type": "number"},
                "wash_sale_risk": {"type": "boolean"},
                "status": {"type": "string", "enum": ["actual", "derived", "estimate"]}
              }
            }
          },
          "recommendations": {
            "type": "array",
            "items": {"type": "string"}
          },
          "status": {"type": "string", "enum": ["actual", "derived", "estimate"]}
        }
      }
    }
  },
  
  "optimization_candidate": {
    "allOf": [{"$ref": "#/artifact_base"}],
    "properties": {
      "kind": {"const": "optimization_candidate"},
      "payload": {
        "type": "object",
        "required": ["allocations", "metrics", "implementation", "validation"],
        "properties": {
          "allocations": {
            "type": "object",
            "additionalProperties": {"type": "number", "minimum": 0, "maximum": 1}
          },
          "metrics": {
            "type": "object",
            "required": ["expected_return", "volatility", "sharpe", "es_975", "es_compliant", "status"],
            "properties": {
              "expected_return": {"type": "number"},
              "volatility": {"type": "number", "minimum": 0},
              "sharpe": {"type": "number"},
              "es_975": {"type": "number"},
              "es_limit": {"type": "number", "const": 0.025},
              "es_compliant": {"type": "boolean"},
              "var_95": {"type": "number"},
              "status": {"type": "string", "enum": ["actual", "derived", "estimate"]}
            }
          },
          "implementation": {
            "type": "object",
            "required": ["method", "rationale"],
            "properties": {
              "method": {"type": "string"},
              "rationale": {"type": "string"},
              "parent_allocation_id": {"type": "string"},
              "revision_reason": {"type": "string"}
            }
          },
          "validation": {
            "type": "object",
            "required": ["round2_gate_passed", "es_compliant", "tax_reconciled"],
            "properties": {
              "round2_gate_passed": {"type": "boolean"},
              "es_compliant": {"type": "boolean"},
              "tax_reconciled": {"type": "boolean"},
              "liquidity_score": {"type": "number", "minimum": 0, "maximum": 1}
            }
          }
        }
      }
    }
  },
  
  "halt_order": {
    "allOf": [{"$ref": "#/artifact_base"}],
    "properties": {
      "kind": {"const": "halt_order"},
      "payload": {
        "type": "object",
        "required": ["trigger", "es_value", "required_actions", "timestamp"],
        "properties": {
          "trigger": {"type": "string", "enum": ["es_breach", "liquidity_crisis", "concentration_breach", "tax_inconsistency"]},
          "es_value": {"type": "number"},
          "es_limit": {"type": "number", "const": 0.025},
          "liquidity_score": {"type": "number"},
          "concentration_details": {
            "type": "object",
            "properties": {
              "ticker": {"type": "string"},
              "weight": {"type": "number"},
              "limit": {"type": "number"}
            }
          },
          "required_actions": {
            "type": "array",
            "items": {"type": "string"}
          },
          "timestamp": {"type": "string", "format": "date-time"}
        }
      }
    }
  },
  
  "trade_list": {
    "allOf": [{"$ref": "#/artifact_base"}],
    "properties": {
      "kind": {"const": "trade_list"},
      "payload": {
        "type": "object",
        "required": ["trades", "summary", "validation"],
        "properties": {
          "trades": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["order", "ticker", "action", "shares", "price", "amount", "account", "rationale"],
              "properties": {
                "order": {"type": "integer", "minimum": 1},
                "ticker": {"type": "string"},
                "action": {"type": "string", "enum": ["BUY", "SELL"]},
                "shares": {"type": "number"},
                "price": {"type": "number", "minimum": 0},
                "amount": {"type": "number"},
                "account": {"type": "string"},
                "rationale": {"type": "string"}
              }
            }
          },
          "summary": {
            "type": "object",
            "required": ["total_trades", "total_turnover", "estimated_costs"],
            "properties": {
              "total_trades": {"type": "integer", "minimum": 0},
              "total_turnover": {"type": "number", "minimum": 0},
              "turnover_percentage": {"type": "number", "minimum": 0},
              "estimated_costs": {"type": "number", "minimum": 0}
            }
          },
          "validation": {
            "type": "object",
            "required": ["es_after_trades", "es_compliant", "tax_optimized"],
            "properties": {
              "es_after_trades": {"type": "number"},
              "es_compliant": {"type": "boolean"},
              "tax_optimized": {"type": "boolean"},
              "wash_sale_checked": {"type": "boolean"}
            }
          }
        }
      }
    }
  }
}