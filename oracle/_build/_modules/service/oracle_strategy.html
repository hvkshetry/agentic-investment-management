

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>service.oracle_strategy &mdash; Oracle 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Oracle
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Oracle Optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/initializers.html">Initializers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/optimization_types.html">Optimization Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/oracle.html">Oracle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/oracle_strategy.html">OracleStrategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/objectives.html">Objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/constraints.html">Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/helpers.html">Helpers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Oracle</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">service.oracle_strategy</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for service.oracle_strategy</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pulp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.initializers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">initialize_tax_lots</span><span class="p">,</span>
    <span class="n">initialize_targets</span><span class="p">,</span>
    <span class="n">initialize_prices</span><span class="p">,</span>
    <span class="n">initialize_spreads</span><span class="p">,</span>
    <span class="n">initialize_factor_model</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">CASH_CUSIP_ID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.trade_extractor</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_trades</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.constraints</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConstraintsManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.objectives</span><span class="w"> </span><span class="kn">import</span> <span class="n">factor_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.objectives.objective_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectiveManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_max_withdrawal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.reports</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">generate_gain_loss_report</span><span class="p">,</span>
    <span class="n">generate_actuals_report</span><span class="p">,</span>
    <span class="n">generate_drift_report</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.reports.comparison_report</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">generate_drift_comparison_report</span><span class="p">,</span>
    <span class="n">generate_factor_model_comparison_report</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.create_decision_vars</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_decision_variables</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">OracleOptimizationType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.objectives.taxes.tlh</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_tlh_impact</span><span class="p">,</span> <span class="n">TLHTrade</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.trade_applier</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_trades_to_portfolio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.service.helpers.trade_summary</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_trade_summary_from_strategies</span>


<div class="viewcode-block" id="OracleStrategy">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OracleStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A sophisticated portfolio optimization strategy class that handles various types of portfolio rebalancing.</span>

<span class="sd">    This class implements complex portfolio optimization strategies including tax-aware rebalancing,</span>
<span class="sd">    tax-loss harvesting, direct indexing, and withdrawal optimization. It uses linear programming</span>
<span class="sd">    to find optimal trade solutions while considering multiple objectives and constraints.</span>

<span class="sd">    Class Attributes:</span>
<span class="sd">        TAX_NORMALIZATION (float): Normalization factor for tax objective (800)</span>
<span class="sd">        DRIFT_NORMALIZATION (float): Normalization factor for drift objective (100)</span>
<span class="sd">        TRANSACTION_NORMALIZATION (float): Normalization factor for transaction costs (1200)</span>
<span class="sd">        FACTOR_MODEL_NORMALIZATION (float): Normalization factor for factor model objective (60)</span>
<span class="sd">        CASH_DRAG_NORMALIZATION (float): Normalization factor for cash deployment objective (50)</span>
<span class="sd">        DEMINIMUS_CASH_TARGET_PERCENT (float): Minimum possible cash target (0.03%)</span>
<span class="sd">        _next_strategy_id (int): Counter for generating unique strategy IDs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add normalization multipliers as class constants</span>
    <span class="n">TAX_NORMALIZATION</span> <span class="o">=</span> <span class="mi">800</span>
    <span class="n">DRIFT_NORMALIZATION</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">TRANSACTION_NORMALIZATION</span> <span class="o">=</span> <span class="mi">1200</span>
    <span class="n">FACTOR_MODEL_NORMALIZATION</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">CASH_DRAG_NORMALIZATION</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># Multiplier for the cash deployment objective term</span>
    <span class="n">DEMINIMUS_CASH_TARGET_PERCENT</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="o">/</span> <span class="mi">100</span> <span class="c1"># 30 Basis Points for the lowest possible cash target</span>
    
    <span class="c1"># Counter for generating unique strategy IDs</span>
    <span class="n">_next_strategy_id</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="OracleStrategy.__init__">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">tax_lots</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>        
        <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">asset_class_targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spreads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">factor_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">strategy_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimization_type</span><span class="p">:</span> <span class="n">OracleOptimizationType</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">TAX_AWARE</span><span class="p">,</span>
        <span class="n">deminimus_cash_target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">withdrawal_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">enforce_wash_sale_prevention</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize an OracleStrategy instance with portfolio data and optimization parameters.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            tax_lots (pd.DataFrame): Current portfolio tax lots with columns including &#39;identifier&#39;,</span>
<span class="sd">                &#39;tax_lot_id&#39;, &#39;quantity&#39;, &#39;cost_basis&#39;, and &#39;date&#39;</span>
<span class="sd">            prices (pd.DataFrame): Current security prices with columns &#39;identifier&#39; and &#39;price&#39;</span>
<span class="sd">            cash (float): Current portfolio cash balance</span>
<span class="sd">            targets (pd.DataFrame, optional): Target portfolio weights with columns &#39;identifier&#39;,</span>
<span class="sd">                &#39;target_weight&#39;, and &#39;identifiers&#39; (list of equivalent securities)</span>
<span class="sd">            asset_class_targets (pd.DataFrame, optional): Asset class level targets, required if</span>
<span class="sd">                targets is not provided</span>
<span class="sd">            spreads (pd.DataFrame, optional): Bid-ask spreads for securities</span>
<span class="sd">            factor_model (pd.DataFrame, optional): Factor exposures for direct indexing,</span>
<span class="sd">                required if optimization_type is DIRECT_INDEX</span>
<span class="sd">            strategy_id (int, optional): Unique identifier for the strategy. Auto-generated if None</span>
<span class="sd">            optimization_type (OracleOptimizationType | str): Type of optimization strategy to use</span>
<span class="sd">            deminimus_cash_target (float): Minimum cash percentage target (default: 0.0)</span>
<span class="sd">            withdrawal_amount (float): Amount to withdraw from portfolio (default: 0.0)</span>
<span class="sd">            enforce_wash_sale_prevention (bool): Whether to enforce wash sale rules (default: True)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither targets nor asset_class_targets is provided, or if factor_model</span>
<span class="sd">                is required but not provided</span>
<span class="sd">            TypeError: If optimization_type is not a valid OracleOptimizationType or string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize basic data first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be set by Oracle when strategy is added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">withdrawal_amount</span><span class="p">)</span>  <span class="c1"># Ensure non-negative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deminimus_cash_target</span> <span class="o">=</span> <span class="n">deminimus_cash_target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_wash_sale_prevention</span> <span class="o">=</span> <span class="n">enforce_wash_sale_prevention</span>
        
        <span class="c1"># Ensure optimization_type is the correct Enum type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optimization_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">=</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">optimization_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid optimization_type string provided: </span><span class="si">{</span><span class="n">optimization_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optimization_type</span><span class="p">,</span> <span class="n">OracleOptimizationType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">=</span> <span class="n">optimization_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;optimization_type must be an OracleOptimizationType enum or a valid string, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">optimization_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate that at least one of targets or asset_class_targets is provided</span>
        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">asset_class_targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one of targets or asset_class_targets must be provided.&quot;</span><span class="p">)</span>            
        
        <span class="c1"># Generate unique strategy_id if not provided</span>
        <span class="k">if</span> <span class="n">strategy_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">strategy_id</span> <span class="o">=</span> <span class="n">OracleStrategy</span><span class="o">.</span><span class="n">_next_strategy_id</span>
            <span class="n">OracleStrategy</span><span class="o">.</span><span class="n">_next_strategy_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_id</span> <span class="o">=</span> <span class="n">strategy_id</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span> <span class="o">=</span> <span class="n">initialize_tax_lots</span><span class="p">(</span><span class="n">tax_lots</span><span class="p">)</span>
        <span class="c1">#Create targets assuming we do not have a withdrawal amount</span>
        <span class="c1"># If we have a withdrawal amount, we need to re-create the targets with the new cash target later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">initialize_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deminimus_cash_target</span><span class="p">)</span>
        <span class="c1"># Get all identifiers from targets where target_weight &gt; 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_identifiers</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;identifiers&#39;</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_identifiers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_identifiers</span><span class="p">))</span>  <span class="c1"># Remove duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owned_identifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owned_tax_lots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="p">[</span><span class="s1">&#39;tax_lot_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">all_identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owned_identifiers</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_identifiers</span><span class="p">))</span>
        
        <span class="c1"># Initialize prices and spreads (which depend on all_identifiers)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">initialize_prices</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_identifiers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span> <span class="o">=</span> <span class="n">initialize_spreads</span><span class="p">(</span><span class="n">spreads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_identifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">==</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">DIRECT_INDEX</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">factor_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">factor_model</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Factor model is required for DIRECT_INDEX optimization type.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_model_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_model_actual</span> <span class="o">=</span> <span class="n">initialize_factor_model</span><span class="p">(</span><span class="n">factor_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_model_target</span> <span class="o">=</span> <span class="kc">None</span>
        
        
        <span class="c1"># Initialize constraints manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints_manager</span> <span class="o">=</span> <span class="n">ConstraintsManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Initialize objective manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_manager</span> <span class="o">=</span> <span class="n">ObjectiveManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Get the appropriate optimization strategy</span>
        <span class="c1"># Note: optimization_type already stores this information, no need for a separate attribute</span>
        
        <span class="c1"># Validate withdrawal amount</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_portfolio_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span><span class="p">()</span>
            <span class="n">remaining_portfolio_value</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">total_portfolio_value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">remaining_portfolio_value</span> <span class="o">&lt;</span> <span class="mf">0.00001</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">=</span> <span class="n">total_portfolio_value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">&gt;</span> <span class="n">total_portfolio_value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Withdrawal amount ($</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) exceeds total portfolio value ($</span><span class="si">{</span><span class="n">total_portfolio_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1">#Here we need to re-create the targets with the new cash target</span>
            <span class="n">withdraw_target</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">withdrawal_amount</span> <span class="o">/</span> <span class="n">total_portfolio_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_portfolio_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">initialize_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">withdraw_target</span><span class="p">,</span> <span class="n">deminimus_cash_target</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_problem</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be set when optimization is performed</span></div>

    
<div class="viewcode-block" id="OracleStrategy.set_oracle">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.set_oracle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oracle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Oracle reference for this strategy.</span>

<span class="sd">        This method is called by Oracle when the strategy is added to establish</span>
<span class="sd">        a bidirectional relationship between Oracle and Strategy instances.</span>

<span class="sd">        Args:</span>
<span class="sd">            oracle: The Oracle instance this strategy belongs to</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If attempting to access Oracle reference before it&#39;s set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span> <span class="o">=</span> <span class="n">oracle</span></div>

        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">date</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current date from the Oracle instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            date: The current date set in the Oracle instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If Oracle reference is not set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Oracle reference not set&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">current_date</span>
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gain_loss_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a gain/loss report for all tax lots using current prices.</span>

<span class="sd">        This cached property calculates realized and unrealized gains/losses</span>
<span class="sd">        for all tax lots in the portfolio based on current market prices.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame containing gain/loss information for each tax lot</span>
<span class="sd">                including columns for cost basis, market value, and gain/loss amounts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">generate_gain_loss_report</span><span class="p">(</span>
            <span class="n">tax_lots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="p">,</span>
            <span class="n">prices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
            <span class="n">current_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_date</span><span class="p">,</span>
            <span class="n">tax_rates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">tax_rates</span>
        <span class="p">)</span>
    

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate actual portfolio weights based on current tax lots and prices.</span>

<span class="sd">        This cached property computes the current portfolio allocation including</span>
<span class="sd">        both security positions and cash, with weights calculated as percentages</span>
<span class="sd">        of total portfolio value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame containing actual portfolio weights and market values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">generate_actuals_report</span><span class="p">(</span>
            <span class="n">tax_lots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="p">,</span>
            <span class="n">prices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
            <span class="n">cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span>
        <span class="p">)</span>
    
<div class="viewcode-block" id="OracleStrategy.total_value">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.total_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the total market value of the portfolio.</span>

<span class="sd">        Sums the market value of all positions including cash to determine</span>
<span class="sd">        the total portfolio value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Total portfolio market value in base currency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">[</span><span class="s1">&#39;market_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="OracleStrategy.min_cash_amount">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.min_cash_amount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">min_cash_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the minimum cash amount required to meet target weights.</span>

<span class="sd">        The minimum cash amount is calculated using a hard limit that is:</span>
<span class="sd">        1. At least self.deminimus_cash_target (3 bps)</span>
<span class="sd">        2. No more than 97.5% of the target cash weight</span>
<span class="sd">        3. No more than the current actual cash percentage</span>
<span class="sd">        4. Capped at 100%</span>
<span class="sd">        5. Rounded to 8 decimal places</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Minimum required cash amount in base currency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_value</span><span class="p">()</span>
        
        <span class="c1"># Get target cash weight</span>
        <span class="n">cash_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;asset_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">CASH_CUSIP_ID</span><span class="p">][</span><span class="s1">&#39;target_weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Get current actual cash percentage</span>
        <span class="n">current_cash_percentage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">/</span> <span class="n">total_value</span> <span class="k">if</span> <span class="n">total_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Calculate hard limit as a percentage (between 0 and 100)</span>
        <span class="n">hard_limit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deminimus_cash_target</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">cash_target</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.975</span><span class="p">)),</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        
        <span class="c1"># Ensure hard limit doesn&#39;t exceed current actual cash percentage</span>
        <span class="k">if</span> <span class="n">hard_limit</span> <span class="o">&gt;=</span> <span class="n">current_cash_percentage</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">hard_limit</span> <span class="o">=</span> <span class="n">current_cash_percentage</span> <span class="o">*</span> <span class="mi">100</span>
            
        <span class="c1"># Convert percentage back to decimal for final calculation</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">hard_limit</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">total_value</span></div>


    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">drift_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a report comparing current portfolio weights to target weights.</span>

<span class="sd">        This cached property calculates the drift between actual and target weights</span>
<span class="sd">        for all positions in the portfolio, including cash.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: DataFrame containing drift information including columns</span>
<span class="sd">                for actual weights, target weights, and drift amounts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">generate_drift_report</span><span class="p">(</span>
            <span class="n">targets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">actuals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_decision_variables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">buy_identifiers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">gain_loss</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create decision variables for the optimization problem.</span>

<span class="sd">        Creates PuLP variables for buy and sell decisions that will be used</span>
<span class="sd">        in the optimization problem constraints and objective function.</span>

<span class="sd">        Args:</span>
<span class="sd">            buy_identifiers (list[str]): List of identifiers that can be bought</span>
<span class="sd">            gain_loss (pd.DataFrame): Gain/loss report for current positions</span>
<span class="sd">            debug (bool): Whether to print debug information</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict, dict, dict]: Tuple containing:</span>
<span class="sd">                - Dictionary of buy variables</span>
<span class="sd">                - Dictionary of sell variables</span>
<span class="sd">                - Dictionary of buy dataframes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">create_decision_variables</span><span class="p">(</span><span class="n">buy_identifiers</span><span class="o">=</span><span class="n">buy_identifiers</span><span class="p">,</span> <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span> <span class="n">prices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_initial_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">buys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">sells</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">gain_loss</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set initial values for optimization variables based on current portfolio state.</span>

<span class="sd">        Provides a warm start for the solver by initializing buy and sell variables</span>
<span class="sd">        with reasonable starting values based on the current portfolio state.</span>

<span class="sd">        Args:</span>
<span class="sd">            buys (Dict[str, pulp.LpVariable]): Dictionary of buy decision variables</span>
<span class="sd">            sells (Dict[str, pulp.LpVariable]): Dictionary of sell decision variables</span>
<span class="sd">            gain_loss (pd.DataFrame): Gain/loss report for current positions</span>
<span class="sd">            debug (bool): Whether to print debug information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize all buys to 0 (no initial purchases)</span>
        <span class="k">for</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">buy_var</span> <span class="ow">in</span> <span class="n">buys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">buy_var</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1"># Initialize sells to 0 quantities (no initial sells)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lot</span> <span class="ow">in</span> <span class="n">gain_loss</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">lot</span><span class="p">[</span><span class="s1">&#39;tax_lot_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sells</span><span class="p">:</span>
                <span class="n">sells</span><span class="p">[</span><span class="n">lot</span><span class="p">[</span><span class="s1">&#39;tax_lot_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set initial values for optimization variables:&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Initialized </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buys</span><span class="p">)</span><span class="si">}</span><span class="s2"> buy variables to 0&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Initialized </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sells</span><span class="p">)</span><span class="si">}</span><span class="s2"> sell variables to 0&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_optimization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prob</span><span class="p">:</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the optimization problem using the CBC solver.</span>

<span class="sd">        Attempts to solve the given linear programming problem and handles</span>
<span class="sd">        various solution statuses and potential failures.</span>

<span class="sd">        Args:</span>
<span class="sd">            prob (pulp.LpProblem): The PuLP optimization problem to solve</span>
<span class="sd">            debug (bool): Whether to print debug information</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[int, float]: Tuple containing:</span>
<span class="sd">                - Solution status code (e.g., pulp.LpStatusOptimal)</span>
<span class="sd">                - Optimized objective value (or None if optimization failed)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="kn">from</span><span class="w"> </span><span class="nn">src.solvers</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_optimization_problem</span>
        
        <span class="n">status</span><span class="p">,</span> <span class="n">optimized_value</span> <span class="o">=</span> <span class="n">solve_optimization_problem</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="c1"># logger.info for debug steps</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solution status: </span><span class="si">{</span><span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">status</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking individual constraints for feasibility...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">constraint_value</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                    <span class="c1"># Log constraint value at debug level</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constraint </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s2"> -&gt; Value: </span><span class="si">{</span><span class="n">constraint_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># logger.warning if constraint evaluation fails</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not evaluate constraint </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatusOptimal</span><span class="p">:</span>
            <span class="c1"># Use logger.warning for non-optimal solutions</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization finished with status: </span><span class="si">{</span><span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">status</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">optimized_value</span>

<div class="viewcode-block" id="OracleStrategy.to_dict">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the strategy&#39;s state to a dictionary for serialization.</span>

<span class="sd">        Converts all strategy data, including DataFrames and complex objects,</span>
<span class="sd">        into a JSON-serializable dictionary format for storage or transmission.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing all strategy data with properly formatted dates</span>
<span class="sd">                and serializable values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert DataFrames to dictionaries with date handling</span>
        <span class="n">tax_lots_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tax_lots_dict</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">tax_lots_dict</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Handle null dates and ensure proper datetime conversion</span>
            <span class="n">tax_lots_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tax_lots_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
            <span class="n">tax_lots_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tax_lots_dict</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tax_lots_dict</span> <span class="o">=</span> <span class="n">tax_lots_dict</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;strategy_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy_id</span><span class="p">,</span>
            <span class="s2">&quot;optimization_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="p">,</span>
            <span class="s2">&quot;cash&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
            <span class="s2">&quot;withdrawal_amount&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span><span class="p">,</span>
            <span class="s2">&quot;tax_lots&quot;</span><span class="p">:</span> <span class="n">tax_lots_dict</span><span class="p">,</span>
            <span class="s2">&quot;targets&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
            <span class="s2">&quot;prices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">),</span>
            <span class="s2">&quot;spreads&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="OracleStrategy.from_dict">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OracleStrategy&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new OracleStrategy instance from a dictionary.</span>

<span class="sd">        Factory method to reconstruct an OracleStrategy instance from a serialized</span>
<span class="sd">        dictionary format, typically created by to_dict().</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): Dictionary containing strategy data</span>

<span class="sd">        Returns:</span>
<span class="sd">            OracleStrategy: New instance initialized with the provided data</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required data is missing or invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert date strings back to datetime</span>
        <span class="n">tax_lots_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tax_lots&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tax_lots_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">tax_lots_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tax_lots_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        
        <span class="c1"># Get optimization type from string, default to TAX_AWARE if not present</span>
        <span class="n">optimization_type_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimization_type&quot;</span><span class="p">,</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">TAX_AWARE</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">optimization_type</span> <span class="o">=</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">optimization_type_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Use logger.warning for invalid input with fallback</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid optimization_type &#39;</span><span class="si">{</span><span class="n">optimization_type_str</span><span class="si">}</span><span class="s2">&#39; in data. Defaulting to TAX_AWARE.&quot;</span><span class="p">)</span>
            <span class="n">optimization_type</span> <span class="o">=</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">TAX_AWARE</span>
            
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">tax_lots</span><span class="o">=</span><span class="n">tax_lots_df</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]),</span>
            <span class="n">prices</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;prices&quot;</span><span class="p">]),</span>
            <span class="n">spreads</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;spreads&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;spreads&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">factor_model</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;factor_model&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;factor_model&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">cash</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cash&quot;</span><span class="p">],</span>
            <span class="n">strategy_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy_id&quot;</span><span class="p">),</span>
            <span class="n">optimization_type</span><span class="o">=</span><span class="n">optimization_type</span><span class="p">,</span>
            <span class="n">withdrawal_amount</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;withdrawal_amount&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_numerical_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for potential numerical stability issues in optimization values.</span>

<span class="sd">        Monitors for values that might cause numerical instability in the optimization,</span>
<span class="sd">        such as very large or very small numbers.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The numerical value to check</span>
<span class="sd">            name (str): Name of the component being checked for logging purposes</span>

<span class="sd">        Note:</span>
<span class="sd">            Logs warnings for values with absolute value &gt; 1e8 or &lt; 1e-8 (except 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e8</span><span class="p">:</span>
             <span class="c1"># Use logger.warning for potential stability issues</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large value detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
             <span class="c1"># Use logger.warning for potential stability issues</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Very small value detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_trade_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">buys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">sells</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">drift</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">gain_loss</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cash_identifier</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the total buy and sell values for all securities.</span>

<span class="sd">        Computes the market value of all buy and sell trades, taking into account</span>
<span class="sd">        current prices and quantities.</span>

<span class="sd">        Args:</span>
<span class="sd">            buys (dict): Dictionary of buy variables</span>
<span class="sd">            sells (dict): Dictionary of sell variables</span>
<span class="sd">            drift (pd.DataFrame): Drift report</span>
<span class="sd">            gain_loss (pd.DataFrame): Gain/loss report</span>
<span class="sd">            cash_identifier (str): Identifier for cash position</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict, dict, float, float]: Tuple containing:</span>
<span class="sd">                - Dictionary of buy values by identifier</span>
<span class="sd">                - Dictionary of sell values by identifier</span>
<span class="sd">                - Total buy value</span>
<span class="sd">                - Total sell value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate total buy value</span>
        <span class="n">buy_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_buy_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">drift</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="n">cash_identifier</span> <span class="ow">or</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buys</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">buy_values</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">buys</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">*</span> <span class="n">price</span>
            <span class="n">total_buy_value</span> <span class="o">+=</span> <span class="n">buy_values</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
        
        <span class="c1"># Calculate total sell value</span>
        <span class="n">sell_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_sell_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_identifiers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="n">cash_identifier</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">identifier_lots</span> <span class="o">=</span> <span class="n">gain_loss</span><span class="p">[</span><span class="n">gain_loss</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">identifier_lots</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sell_values</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">([</span>
                <span class="n">sells</span><span class="p">[</span><span class="n">lot</span><span class="p">[</span><span class="s1">&#39;tax_lot_id&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">price</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lot</span> <span class="ow">in</span> <span class="n">identifier_lots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">lot</span><span class="p">[</span><span class="s1">&#39;tax_lot_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sells</span>
            <span class="p">])</span>
            <span class="n">total_sell_value</span> <span class="o">+=</span> <span class="n">sell_values</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="n">buy_values</span><span class="p">,</span> <span class="n">sell_values</span><span class="p">,</span> <span class="n">total_buy_value</span><span class="p">,</span> <span class="n">total_sell_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_no_trades_scenario</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prob</span><span class="p">:</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">,</span>
        <span class="n">buys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">sells</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the optimization problem with all trades forced to zero.</span>

<span class="sd">        Creates and solves a modified version of the optimization problem where</span>
<span class="sd">        all trading is prohibited, to establish a baseline for comparison.</span>

<span class="sd">        Args:</span>
<span class="sd">            prob (pulp.LpProblem): The original optimization problem</span>
<span class="sd">            buys (Dict[str, pulp.LpVariable]): Dictionary of buy variables</span>
<span class="sd">            sells (Dict[str, pulp.LpVariable]): Dictionary of sell variables</span>
<span class="sd">            debug (bool): Whether to print debug information</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[Optional[int], Optional[float], Optional[Dict]]: Tuple containing:</span>
<span class="sd">                - Solution status code</span>
<span class="sd">                - Optimized value for no-trades scenario</span>
<span class="sd">                - Dictionary of objective component values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a copy for no-trades scenario</span>
        <span class="n">prob_no_trades</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Add constraints to force all variables to zero in no-trades copy</span>
        <span class="k">for</span> <span class="n">buy_var</span> <span class="ow">in</span> <span class="n">buys</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">prob_no_trades</span> <span class="o">+=</span> <span class="n">buy_var</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;no_trade_buy_</span><span class="si">{</span><span class="n">buy_var</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">sell_var</span> <span class="ow">in</span> <span class="n">sells</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">prob_no_trades</span> <span class="o">+=</span> <span class="n">sell_var</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;no_trade_sell_</span><span class="si">{</span><span class="n">sell_var</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Solving no-trades scenario first...&quot;</span><span class="p">)</span>
        
        <span class="n">status</span><span class="p">,</span> <span class="n">optimized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_optimization</span><span class="p">(</span><span class="n">prob_no_trades</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        
        <span class="c1"># Extract component values if solve was successful</span>
        <span class="n">component_values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatusOptimal</span><span class="p">:</span>
            <span class="n">component_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_manager</span><span class="o">.</span><span class="n">extract_component_values</span><span class="p">(</span><span class="n">prob_no_trades</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No-trades objective components:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">component_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">optimized_value</span><span class="p">,</span> <span class="n">component_values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_tlh_optimization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prob</span><span class="p">:</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">,</span>
        <span class="n">buys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">sells</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">drift_report</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">gain_loss</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">total_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_notional</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">TLHTrade</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle tax-loss harvesting (TLH) optimization if enabled.</span>

<span class="sd">        Identifies tax-loss harvesting opportunities and modifies the optimization</span>
<span class="sd">        problem to incorporate TLH objectives and constraints.</span>

<span class="sd">        Args:</span>
<span class="sd">            prob (pulp.LpProblem): The optimization problem</span>
<span class="sd">            buys (Dict[str, pulp.LpVariable]): Dictionary of buy variables</span>
<span class="sd">            sells (Dict[str, pulp.LpVariable]): Dictionary of sell variables</span>
<span class="sd">            drift_report (pd.DataFrame): Current drift report</span>
<span class="sd">            gain_loss (pd.DataFrame): Gain/loss report</span>
<span class="sd">            total_value (float): Total portfolio value</span>
<span class="sd">            min_notional (float): Minimum notional amount for any trade</span>
<span class="sd">            debug (bool): Whether to print debug information</span>
<span class="sd">            log_time (bool): Whether to log timing information</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[TLHTrade], Optional[Dict]]: Tuple containing:</span>
<span class="sd">                - List of identified TLH trade opportunities</span>
<span class="sd">                - Dictionary of TLH baseline components (or None if TLH not enabled)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If wash sale restrictions are not set but TLH is enabled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timing_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">tlh_trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tlh_baseline_components</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">should_tlh</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_tlh</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tlh_trades</span><span class="p">,</span> <span class="n">tlh_baseline_components</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">wash_sale_restrictions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wash sale restrictions not set in Oracle but we&#39;re trying to TLH.&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">tlh_impact_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Add TLH impact to objective function</span>
        <span class="n">tlh_opportunities</span><span class="p">,</span> <span class="n">sell_quantities</span><span class="p">,</span> <span class="n">buy_quantities</span><span class="p">,</span> <span class="n">tlh_baseline_components</span> <span class="o">=</span> <span class="n">calculate_tlh_impact</span><span class="p">(</span>
            <span class="n">prob</span><span class="o">=</span><span class="n">prob</span><span class="p">,</span>
            <span class="n">buys</span><span class="o">=</span><span class="n">buys</span><span class="p">,</span>
            <span class="n">sells</span><span class="o">=</span><span class="n">sells</span><span class="p">,</span>
            <span class="n">drift_report</span><span class="o">=</span><span class="n">drift_report</span><span class="p">,</span>
            <span class="n">gain_loss_report</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
            <span class="n">prices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
            <span class="n">tax_rates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">tax_rates</span><span class="p">,</span>
            <span class="n">constraints_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints_manager</span><span class="p">,</span>
            <span class="n">target_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">total_portfolio_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
            <span class="n">min_weight_multiplier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">range_min_weight_multiplier</span><span class="p">,</span>
            <span class="n">max_weight_multiplier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">range_max_weight_multiplier</span><span class="p">,</span>
            <span class="n">min_notional</span><span class="o">=</span><span class="n">min_notional</span><span class="p">,</span>
            <span class="n">trade_rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_rounding</span><span class="p">,</span>
            <span class="n">min_loss_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tlh_min_loss_threshold</span><span class="p">,</span>
            <span class="n">objective_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_manager</span><span class="p">,</span>
            <span class="n">optimization_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;tlh_impact_calculation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tlh_impact_start</span>
        
        <span class="c1"># Store TLH trades for later use</span>
        <span class="n">tlh_trades</span> <span class="o">=</span> <span class="n">tlh_opportunities</span>
        
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">tlh_opportunities</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tlh_opportunities</span><span class="p">)</span><span class="si">}</span><span class="s2"> TLH opportunities:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">tlh_opportunities</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">loss_percentage</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> loss, &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;potential savings $</span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">potential_tax_savings</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">tlh_baseline_components</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TLH baseline objective components:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== TLH Optimization Timing Breakdown ===&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">timing_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
                    
        <span class="k">return</span> <span class="n">tlh_trades</span><span class="p">,</span> <span class="n">tlh_baseline_components</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_try_buy_only_optimization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">buy_only_prob</span><span class="p">:</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">,</span>
        <span class="n">buys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">sells</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">],</span>
        <span class="n">drift</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">gain_loss</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">total_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">no_trade_optimized_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">buy_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">holding_time_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span>
        <span class="n">min_notional</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">actual_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">improvement</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">rebalance_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">buy_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sell_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try buy-only optimization if full rebalance doesn&#39;t meet improvement threshold.</span>

<span class="sd">        Attempts a more conservative optimization approach that only allows purchases,</span>
<span class="sd">        useful when a full rebalance would not provide sufficient improvement to</span>
<span class="sd">        justify the trading costs.</span>

<span class="sd">        Args:</span>
<span class="sd">            buy_only_prob (pulp.LpProblem): The optimization problem for buy-only scenario</span>
<span class="sd">            buys (Dict[str, pulp.LpVariable]): Dictionary of buy variables</span>
<span class="sd">            sells (Dict[str, pulp.LpVariable]): Dictionary of sell variables</span>
<span class="sd">            drift (pd.DataFrame): Current drift report</span>
<span class="sd">            gain_loss (pd.DataFrame): Gain/loss report</span>
<span class="sd">            total_value (float): Total portfolio value</span>
<span class="sd">            min_cash (float): Minimum required cash amount</span>
<span class="sd">            no_trade_optimized_value (float): Optimized value from no-trade scenario</span>
<span class="sd">            buy_threshold (float): Minimum improvement threshold for buy-only trades</span>
<span class="sd">            holding_time_delta (Optional[datetime]): Optional holding time constraint</span>
<span class="sd">            min_notional (float): Minimum notional amount for any trade</span>
<span class="sd">            actual_cash (float): Current cash position</span>
<span class="sd">            improvement (float): Current improvement from full rebalance</span>
<span class="sd">            rebalance_threshold (float): Threshold for full rebalance</span>
<span class="sd">            buy_df (Optional[pd.DataFrame]): Buy decisions dataframe</span>
<span class="sd">            sell_df (Optional[pd.DataFrame]): Sell decisions dataframe</span>
<span class="sd">            debug (bool): Whether to print debug information</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Optional[int], Optional[float], pulp.LpProblem, bool, Optional[Dict]]:</span>
<span class="sd">                - Solution status code</span>
<span class="sd">                - Optimized value for buy-only scenario</span>
<span class="sd">                - Modified problem object</span>
<span class="sd">                - Whether this is a buy-only optimization</span>
<span class="sd">                - Failure context dictionary (if optimization failed or didn&#39;t meet threshold)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First check if we have enough cash</span>
        <span class="k">if</span> <span class="n">actual_cash</span> <span class="o">&lt;</span> <span class="n">min_cash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough cash ($</span><span class="si">{</span><span class="n">actual_cash</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">) to meet minimum requirement ($</span><span class="si">{</span><span class="n">min_cash</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">). Skipping buy-only optimization.&quot;</span><span class="p">)</span>
            <span class="n">failure_context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;case_type&#39;</span><span class="p">:</span> <span class="s1">&#39;not_enough_cash_to_buy_only&#39;</span><span class="p">,</span>
                <span class="s1">&#39;improvements&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;rebalance&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">improvement</span><span class="p">,</span>
                        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">rebalance_threshold</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;additional_info&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;actual_cash&#39;</span><span class="p">:</span> <span class="n">actual_cash</span><span class="p">,</span>
                    <span class="s1">&#39;min_cash&#39;</span><span class="p">:</span> <span class="n">min_cash</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">buy_only_prob</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">failure_context</span>

        <span class="c1"># Create a new problem for buy-only optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_problem</span> <span class="o">=</span> <span class="n">buy_only_prob</span>
        
        <span class="c1"># Force all sells to zero</span>
        <span class="k">for</span> <span class="n">sell_var</span> <span class="ow">in</span> <span class="n">sells</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">buy_only_prob</span> <span class="o">+=</span> <span class="n">sell_var</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;force_no_sell_</span><span class="si">{</span><span class="n">sell_var</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Solve buy-only optimization</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">buy_only_optimized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_optimization</span><span class="p">(</span><span class="n">buy_only_prob</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatusOptimal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Buy-only optimization failed.&quot;</span><span class="p">)</span>
            <span class="n">failure_context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;case_type&#39;</span><span class="p">:</span> <span class="s1">&#39;buy_only_failed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;improvements&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;rebalance&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">improvement</span><span class="p">,</span>
                        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">rebalance_threshold</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;optimization_status&#39;</span><span class="p">:</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Failed before solve&#39;</span><span class="p">,</span>
                <span class="s1">&#39;additional_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span> <span class="s1">&#39;min_cash&#39;</span><span class="p">:</span> <span class="n">min_cash</span><span class="p">,</span> <span class="s1">&#39;actual_cash&#39;</span><span class="p">:</span> <span class="n">actual_cash</span><span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">buy_only_prob</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">failure_context</span>
        
        <span class="c1"># Check improvement against buy threshold</span>
        <span class="n">buy_only_improvement</span> <span class="o">=</span> <span class="n">no_trade_optimized_value</span> <span class="o">-</span> <span class="n">buy_only_optimized_value</span>
        <span class="k">if</span> <span class="n">buy_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">buy_only_improvement</span> <span class="o">&lt;</span> <span class="n">buy_threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buy-only improvement (</span><span class="si">{</span><span class="n">buy_only_improvement</span><span class="si">}</span><span class="s2">) is below threshold (</span><span class="si">{</span><span class="n">buy_threshold</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="n">failure_context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;case_type&#39;</span><span class="p">:</span> <span class="s1">&#39;buy_only_below_threshold&#39;</span><span class="p">,</span>
                <span class="s1">&#39;improvements&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;rebalance&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">improvement</span><span class="p">,</span>
                        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">rebalance_threshold</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;buy_only&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">buy_only_improvement</span><span class="p">,</span>
                        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">buy_threshold</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;additional_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;min_cash&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">min_cash</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;actual_cash&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">actual_cash</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">buy_only_prob</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">failure_context</span>
            
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">buy_only_optimized_value</span><span class="p">,</span> <span class="n">buy_only_prob</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

<div class="viewcode-block" id="OracleStrategy.compute_optimal_trades">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.compute_optimal_trades">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_optimal_trades</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weight_tax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">weight_drift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">weight_transaction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">weight_factor_model</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">weight_cash_drag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  
        <span class="n">rebalance_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  
        <span class="n">buy_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  
        <span class="n">holding_time_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">should_tlh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tlh_min_loss_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">,</span>  
        <span class="n">range_min_weight_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>  
        <span class="n">range_max_weight_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>  
        <span class="n">min_notional</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  
        <span class="n">rank_penalty_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  
        <span class="n">trade_rounding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">enforce_wash_sale_prevention</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">dump</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute optimal trades using linear optimization.</span>

<span class="sd">        This is the main optimization method that attempts to find the optimal set</span>
<span class="sd">        of trades to achieve the portfolio&#39;s objectives while respecting all constraints.</span>
<span class="sd">        It can handle various optimization types including tax-aware rebalancing,</span>
<span class="sd">        tax-loss harvesting, and direct indexing.</span>

<span class="sd">        Args:</span>
<span class="sd">            weight_tax (float): Weight for tax objective component (default: 1)</span>
<span class="sd">            weight_drift (float): Weight for drift objective component (default: 1)</span>
<span class="sd">            weight_transaction (float): Weight for transaction cost component (default: 1)</span>
<span class="sd">            weight_factor_model (float): Weight for factor model objective (default: 0.0)</span>
<span class="sd">            weight_cash_drag (float): Weight for cash penalty component (default: 0.0)</span>
<span class="sd">            rebalance_threshold (float, optional): Minimum improvement for full rebalance</span>
<span class="sd">            buy_threshold (float, optional): Minimum improvement for buy-only trades</span>
<span class="sd">            holding_time_days (int): Minimum holding period in days (default: 0)</span>
<span class="sd">            should_tlh (bool): Whether to enable tax-loss harvesting (default: False)</span>
<span class="sd">            tlh_min_loss_threshold (float): Minimum loss % for TLH (default: 1.5%)</span>
<span class="sd">            range_min_weight_multiplier (float): Lower bound for weight ranges (default: 0.5)</span>
<span class="sd">            range_max_weight_multiplier (float): Upper bound for weight ranges (default: 2.0)</span>
<span class="sd">            min_notional (float): Minimum notional amount for trades (default: 0)</span>
<span class="sd">            rank_penalty_factor (float): Factor for rank penalty (default: 0.0)</span>
<span class="sd">            trade_rounding (int): Decimal places for trade rounding (default: 4)</span>
<span class="sd">            enforce_wash_sale_prevention (bool): Whether to enforce wash sale rules (default: True)</span>
<span class="sd">            debug (bool): Whether to print debug information (default: True)</span>
<span class="sd">            dump (bool): Whether to dump strategy state (default: False)</span>
<span class="sd">            log_time (bool): Whether to log execution times (default: True)</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[Optional[int], bool, Dict, pd.DataFrame]: Tuple containing:</span>
<span class="sd">                - Solution status code (or None if optimization failed)</span>
<span class="sd">                - Whether trades should be executed</span>
<span class="sd">                - Trade summary dictionary with optimization statistics</span>
<span class="sd">                - DataFrame of recommended trades</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If optimization parameters are invalid or incompatible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">timing_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Store optimization parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_tax</span> <span class="o">=</span> <span class="n">weight_tax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_drift</span> <span class="o">=</span> <span class="n">weight_drift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_transaction</span> <span class="o">=</span> <span class="n">weight_transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_factor_model</span> <span class="o">=</span> <span class="n">weight_factor_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_cash_drag</span> <span class="o">=</span> <span class="n">weight_cash_drag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebalance_threshold</span> <span class="o">=</span> <span class="n">rebalance_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_threshold</span> <span class="o">=</span> <span class="n">buy_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding_time_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">holding_time_days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_notional</span> <span class="o">=</span> <span class="n">min_notional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_penalty_factor</span> <span class="o">=</span> <span class="n">rank_penalty_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlh_min_loss_threshold</span> <span class="o">=</span> <span class="n">tlh_min_loss_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_tlh</span> <span class="o">=</span> <span class="n">should_tlh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_rounding</span> <span class="o">=</span> <span class="n">trade_rounding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_min_weight_multiplier</span> <span class="o">=</span> <span class="n">range_min_weight_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_max_weight_multiplier</span> <span class="o">=</span> <span class="n">range_max_weight_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_wash_sale_prevention</span> <span class="o">=</span> <span class="n">enforce_wash_sale_prevention</span>

        <span class="k">if</span> <span class="n">dump</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">oracle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#TODO: DUMP STATE</span>

        <span class="c1"># Early exit for HOLD strategy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span> <span class="o">==</span> <span class="n">OracleOptimizationType</span><span class="o">.</span><span class="n">HOLD</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization Type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">. Returning no trades.&quot;</span><span class="p">)</span>
            <span class="n">empty_summary</span> <span class="o">=</span> <span class="n">generate_trade_summary_from_strategies</span><span class="p">(</span>
                <span class="n">pre_strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">is_2nd_buy_only_optimization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">trades</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
                <span class="n">total_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">before_optimization</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">after_optimization</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">explanation_context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;case_type&#39;</span><span class="p">:</span> <span class="s1">&#39;hold_strategy&#39;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">empty_summary</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Early validation for withdrawal compatibility</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_context</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">can_handle_withdrawal</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not compatible with withdrawals&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Withdrawal amount: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> with optimization type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;initialization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialization time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;initialization&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">report_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Initialize and get current portfolio state</span>
        <span class="n">gain_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain_loss_report</span>
        <span class="n">drift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_report</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">[</span><span class="s1">&#39;market_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;report_generation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">report_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Report generation time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;report_generation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">problem_setup_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Early exit if portfolio is empty</span>
        <span class="k">if</span> <span class="n">total_value</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;asset_class&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CASH_CUSIP_ID</span><span class="p">][</span><span class="s1">&#39;target_weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Portfolio is empty and no non-cash targets. Returning no trades.&quot;</span><span class="p">)</span>
            <span class="n">empty_summary</span> <span class="o">=</span> <span class="n">generate_trade_summary_from_strategies</span><span class="p">(</span>
                <span class="n">pre_strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">is_2nd_buy_only_optimization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">trades</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
                <span class="n">total_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">before_optimization</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">after_optimization</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">explanation_context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;case_type&#39;</span><span class="p">:</span> <span class="s1">&#39;empty_portfolio&#39;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">empty_summary</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Create optimization problem</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">(</span><span class="s2">&quot;Portfolio_Rebalance&quot;</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpMinimize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_problem</span> <span class="o">=</span> <span class="n">prob</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_decision_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_identifiers</span><span class="p">,</span> <span class="n">gain_loss</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building Optimization Problem (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">) ===&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Withdrawal amount: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Apply strategy-specific setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_type</span><span class="o">.</span><span class="n">setup_optimization</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;problem_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">problem_setup_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Problem setup time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;problem_setup&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">objective_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Use ObjectiveManager to calculate and set the objective function</span>
        <span class="n">total_objective</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_manager</span><span class="o">.</span><span class="n">calculate_objectives</span><span class="p">(</span>
            <span class="n">buys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span>
            <span class="n">sells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span>
            <span class="n">drift</span><span class="o">=</span><span class="n">drift</span><span class="p">,</span>
            <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
            <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
            <span class="n">weight_tax</span><span class="o">=</span><span class="n">weight_tax</span><span class="p">,</span>
            <span class="n">weight_drift</span><span class="o">=</span><span class="n">weight_drift</span><span class="p">,</span>
            <span class="n">weight_transaction</span><span class="o">=</span><span class="n">weight_transaction</span><span class="p">,</span>
            <span class="n">weight_factor_model</span><span class="o">=</span><span class="n">weight_factor_model</span><span class="p">,</span>
            <span class="n">weight_cash_drag</span><span class="o">=</span><span class="n">weight_cash_drag</span><span class="p">,</span>
            <span class="n">rank_penalty_factor</span><span class="o">=</span><span class="n">rank_penalty_factor</span><span class="p">,</span>
            <span class="n">buy_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buy_df</span><span class="p">,</span>
            <span class="n">sell_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sell_df</span><span class="p">,</span>
            <span class="n">enforce_wash_sale_prevention</span><span class="o">=</span><span class="n">enforce_wash_sale_prevention</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="n">log_time</span><span class="o">=</span><span class="n">log_time</span>
        <span class="p">)</span>

        <span class="n">prob</span> <span class="o">+=</span> <span class="n">total_objective</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;objective_calculation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">objective_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Objective calculation time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;objective_calculation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">no_trade_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Solve no-trades scenario BEFORE adding constraints</span>
        <span class="n">no_trade_status</span><span class="p">,</span> <span class="n">no_trade_optimized_value</span><span class="p">,</span> <span class="n">no_trade_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_no_trades_scenario</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_trade_optimized_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">no_trade_optimized_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No-trades scenario failed to solve.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to solve no-trades scenario. Check the problem setup.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;no_trade_scenario&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">no_trade_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No trade scenario time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;no_trade_scenario&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">constraints_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Handle withdrawal if applicable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints_manager</span><span class="o">.</span><span class="n">add_withdrawal_constraints</span><span class="p">(</span>
                <span class="n">prob</span><span class="o">=</span><span class="n">prob</span><span class="p">,</span>
                <span class="n">buys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span>
                <span class="n">sells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span>
                <span class="n">drift</span><span class="o">=</span><span class="n">drift</span><span class="p">,</span>
                <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
                <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
                <span class="n">withdrawal_amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">withdrawal_amount</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
            <span class="p">)</span>
        
        <span class="c1"># Store the no-trade component breakdown for reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_trade_component_values</span> <span class="o">=</span> <span class="n">no_trade_components</span>
        
        <span class="c1"># Add general constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_cash_amount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints_manager</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span>
            <span class="n">prob</span><span class="o">=</span><span class="n">prob</span><span class="p">,</span>
            <span class="n">buys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span>
            <span class="n">sells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span>
            <span class="n">prices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
            <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
            <span class="n">tax_lots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="p">,</span>
            <span class="n">min_cash_amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_cash</span><span class="p">,</span>
            <span class="n">holding_time_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">holding_time_delta</span><span class="p">,</span>
            <span class="n">min_notional</span><span class="o">=</span><span class="n">min_notional</span><span class="p">,</span>
            <span class="n">buy_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buy_df</span><span class="p">,</span>
            <span class="n">sell_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sell_df</span><span class="p">,</span>
            <span class="n">enforce_wash_sale_prevention</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enforce_wash_sale_prevention</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;constraints_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">constraints_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constraints setup time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;constraints_setup&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">tlh_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#Before we do any TLH, we need to set the buy_only_prob to be the same as prob. This is what we use later in the buy only case.</span>
        <span class="n">buy_only_prob</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Handle TLH if enabled</span>
        <span class="n">tlh_trades</span><span class="p">,</span> <span class="n">tlh_baseline_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tlh_optimization</span><span class="p">(</span>
            <span class="n">prob</span><span class="o">=</span><span class="n">prob</span><span class="p">,</span>
            <span class="n">buys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span>
            <span class="n">sells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span>
            <span class="n">drift_report</span><span class="o">=</span><span class="n">drift</span><span class="p">,</span>
            <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
            <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
            <span class="n">min_notional</span><span class="o">=</span><span class="n">min_notional</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="n">log_time</span><span class="o">=</span><span class="n">log_time</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;tlh_optimization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tlh_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TLH optimization time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;tlh_optimization&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">solve_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Set initial values for warm start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_initial_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span> <span class="n">gain_loss</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
        
        <span class="c1"># Solve the optimization problem</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">optimized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_optimization</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;main_solve&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">solve_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main solve time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;main_solve&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        
        <span class="c1"># Handle solution status</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatusOptimal</span><span class="p">:</span>
            <span class="n">status_str</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Failure before/during solve&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization did not find an optimal solution (Status: </span><span class="si">{</span><span class="n">status_str</span><span class="si">}</span><span class="s2">). Returning empty trades.&quot;</span><span class="p">)</span>
            <span class="n">empty_summary</span> <span class="o">=</span> <span class="n">generate_trade_summary_from_strategies</span><span class="p">(</span>
                <span class="n">pre_strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">is_2nd_buy_only_optimization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">trades</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
                <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
                <span class="n">before_optimization</span><span class="o">=</span><span class="n">no_trade_components</span> <span class="k">if</span> <span class="n">no_trade_components</span> <span class="k">else</span> <span class="p">{},</span>
                <span class="n">after_optimization</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">explanation_context</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;case_type&#39;</span><span class="p">:</span> <span class="s1">&#39;optimization_failed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;optimization_status&#39;</span><span class="p">:</span> <span class="n">status_str</span><span class="p">,</span>
                    <span class="s1">&#39;additional_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">empty_summary</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Check for improvement against rebalance threshold</span>
        <span class="n">no_trade_optimized_value</span> <span class="o">=</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overall&#39;</span><span class="p">,</span> <span class="n">no_trade_optimized_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">tlh_baseline_components</span> <span class="k">else</span> <span class="n">no_trade_optimized_value</span>
        <span class="n">improvement</span> <span class="o">=</span> <span class="n">no_trade_optimized_value</span> <span class="o">-</span> <span class="n">optimized_value</span>
        <span class="n">is_2nd_buy_only_optimization</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">should_trade</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">no_trade_status</span> <span class="o">==</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpStatusOptimal</span> <span class="ow">and</span> <span class="n">rebalance_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">improvement</span> <span class="o">&lt;</span> <span class="n">rebalance_threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rebalance improvement (</span><span class="si">{</span><span class="n">improvement</span><span class="si">}</span><span class="s2">) is below threshold (</span><span class="si">{</span><span class="n">rebalance_threshold</span><span class="si">}</span><span class="s2">). Trying buy-only optimization.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
                <span class="n">buy_only_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># Calculate actual cash position</span>
            <span class="n">actual_cash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">CASH_CUSIP_ID</span><span class="p">][</span><span class="s1">&#39;market_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">status</span><span class="p">,</span> <span class="n">buy_only_optimized_value</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">is_2nd_buy_only_optimization</span><span class="p">,</span> <span class="n">failure_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_buy_only_optimization</span><span class="p">(</span>
                <span class="n">buy_only_prob</span><span class="o">=</span><span class="n">buy_only_prob</span><span class="p">,</span>
                <span class="n">buys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span>
                <span class="n">sells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span>
                <span class="n">drift</span><span class="o">=</span><span class="n">drift</span><span class="p">,</span>
                <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
                <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
                <span class="n">min_cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_cash</span><span class="p">,</span>
                <span class="n">no_trade_optimized_value</span><span class="o">=</span><span class="n">no_trade_optimized_value</span><span class="p">,</span>
                <span class="n">buy_threshold</span><span class="o">=</span><span class="n">buy_threshold</span><span class="p">,</span>
                <span class="n">holding_time_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">holding_time_delta</span><span class="p">,</span>
                <span class="n">min_notional</span><span class="o">=</span><span class="n">min_notional</span><span class="p">,</span>
                <span class="n">actual_cash</span><span class="o">=</span><span class="n">actual_cash</span><span class="p">,</span>
                <span class="n">improvement</span><span class="o">=</span><span class="n">improvement</span><span class="p">,</span>
                <span class="n">rebalance_threshold</span><span class="o">=</span><span class="n">rebalance_threshold</span><span class="p">,</span>
                <span class="n">buy_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buy_df</span><span class="p">,</span>
                <span class="n">sell_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sell_df</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
                <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;buy_only_optimization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">buy_only_start</span>
            
            <span class="k">if</span> <span class="n">buy_only_optimized_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">buy_only_optimized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_manager</span><span class="o">.</span><span class="n">extract_component_values</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimized_component_values</span> <span class="o">=</span> <span class="n">buy_only_optimized_value</span>
                <span class="n">empty_summary</span> <span class="o">=</span> <span class="n">generate_trade_summary_from_strategies</span><span class="p">(</span>
                    <span class="n">pre_strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">is_2nd_buy_only_optimization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">trades</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
                    <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
                    <span class="n">before_optimization</span><span class="o">=</span><span class="n">no_trade_components</span> <span class="k">if</span> <span class="n">no_trade_components</span> <span class="k">else</span> <span class="p">{},</span>
                    <span class="n">after_optimization</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;tax_cost&#39;</span><span class="p">:</span> <span class="n">buy_only_optimized_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tax&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">buy_only_optimized_value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;drift_cost&#39;</span><span class="p">:</span> <span class="n">buy_only_optimized_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">buy_only_optimized_value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;spread_costs&#39;</span><span class="p">:</span> <span class="n">buy_only_optimized_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">buy_only_optimized_value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;factor_cost&#39;</span><span class="p">:</span> <span class="n">buy_only_optimized_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;factor_model&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">buy_only_optimized_value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;cash_drag&#39;</span><span class="p">:</span> <span class="n">buy_only_optimized_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cash_drag&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">buy_only_optimized_value</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">buy_only_optimized_value</span>
                    <span class="p">},</span>
                    <span class="n">explanation_context</span><span class="o">=</span><span class="n">failure_context</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">empty_summary</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                
            <span class="n">optimized_value</span> <span class="o">=</span> <span class="n">buy_only_optimized_value</span>
            <span class="n">improvement</span> <span class="o">=</span> <span class="n">no_trade_optimized_value</span> <span class="o">-</span> <span class="n">buy_only_optimized_value</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">post_process_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Extract optimized component values</span>
        <span class="n">optimized_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_manager</span><span class="o">.</span><span class="n">extract_component_values</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_component_values</span> <span class="o">=</span> <span class="n">optimized_components</span>

        <span class="c1"># Extract trades</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">extract_trades</span><span class="p">(</span>
            <span class="n">buys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buys</span><span class="p">,</span>
            <span class="n">sells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sells</span><span class="p">,</span>
            <span class="n">gain_loss</span><span class="o">=</span><span class="n">gain_loss</span><span class="p">,</span>
            <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
            <span class="n">prices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
            <span class="n">spreads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">,</span>
            <span class="n">tlh_trades</span><span class="o">=</span><span class="n">tlh_trades</span><span class="p">,</span>
            <span class="n">tax_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TAX_NORMALIZATION</span> <span class="o">*</span> <span class="n">weight_tax</span><span class="p">,</span>
            <span class="n">transaction_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TRANSACTION_NORMALIZATION</span> <span class="o">*</span> <span class="n">weight_transaction</span><span class="p">,</span>
            <span class="n">trade_rounding</span><span class="o">=</span><span class="n">trade_rounding</span><span class="p">,</span>
            <span class="n">min_notional</span><span class="o">=</span><span class="n">min_notional</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">should_trade</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">apply_trades_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
        <span class="c1"># Apply trades to get post-trade strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_trade_strategy</span> <span class="o">=</span> <span class="n">apply_trades_to_portfolio</span><span class="p">(</span>
            <span class="n">tax_lots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tax_lots</span><span class="p">,</span>
            <span class="n">trades</span><span class="o">=</span><span class="n">trades</span><span class="p">,</span>
            <span class="n">cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
            <span class="n">current_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_date</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">log_time</span><span class="o">=</span><span class="n">log_time</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;apply_trades&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">apply_trades_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apply trades time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;apply_trades&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">trade_summary_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Generate trade summary by comparing pre and post strategies</span>
        <span class="n">trade_summary</span> <span class="o">=</span> <span class="n">generate_trade_summary_from_strategies</span><span class="p">(</span>
            <span class="n">pre_strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">is_2nd_buy_only_optimization</span><span class="o">=</span><span class="n">is_2nd_buy_only_optimization</span><span class="p">,</span>
            <span class="n">trades</span><span class="o">=</span><span class="n">trades</span><span class="p">,</span>
            <span class="n">total_value</span><span class="o">=</span><span class="n">total_value</span><span class="p">,</span>
            <span class="n">before_optimization</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;tax_cost&#39;</span><span class="p">:</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tax&#39;</span><span class="p">,</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tax&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlh_baseline_components</span> <span class="k">else</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tax&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;drift_cost&#39;</span><span class="p">:</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift&#39;</span><span class="p">,</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlh_baseline_components</span> <span class="k">else</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;spread_costs&#39;</span><span class="p">:</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">,</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlh_baseline_components</span> <span class="k">else</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;factor_cost&#39;</span><span class="p">:</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;factor_model&#39;</span><span class="p">,</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;factor_model&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlh_baseline_components</span> <span class="k">else</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;factor_model&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;cash_drag&#39;</span><span class="p">:</span> <span class="n">tlh_baseline_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cash_drag&#39;</span><span class="p">,</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cash_drag&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">tlh_baseline_components</span> <span class="k">else</span> <span class="n">no_trade_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cash_drag&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">no_trade_optimized_value</span>
            <span class="p">},</span>
            <span class="n">after_optimization</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;tax_cost&#39;</span><span class="p">:</span> <span class="n">optimized_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tax&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimized_components</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;drift_cost&#39;</span><span class="p">:</span> <span class="n">optimized_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimized_components</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;spread_costs&#39;</span><span class="p">:</span> <span class="n">optimized_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimized_components</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;factor_cost&#39;</span><span class="p">:</span> <span class="n">optimized_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;factor_model&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimized_components</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;cash_drag&#39;</span><span class="p">:</span> <span class="n">optimized_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cash_drag&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimized_components</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">optimized_value</span>
            <span class="p">},</span>
            <span class="n">log_time</span><span class="o">=</span><span class="n">log_time</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_time</span><span class="p">:</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;trade_summary_generation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">trade_summary_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade summary generation time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;trade_summary_generation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;post_processing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">post_process_start</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Post processing time: </span><span class="si">{</span><span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;post_processing&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">timing_data</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            
            <span class="c1"># Log final timing information</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Final Optimization Timing Breakdown ===&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">duration</span> <span class="ow">in</span> <span class="n">timing_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">should_trade</span><span class="p">,</span> <span class="n">trade_summary</span><span class="p">,</span> <span class="n">trades</span></div>


<div class="viewcode-block" id="OracleStrategy.calculate_max_withdrawal_amount">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.calculate_max_withdrawal_amount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_max_withdrawal_amount</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">respect_wash_sales</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">preserve_targets</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the maximum amount that can be withdrawn from the portfolio.</span>

<span class="sd">        Creates a special optimization problem that attempts to liquidate as much</span>
<span class="sd">        of the portfolio as possible while respecting specified constraints.</span>

<span class="sd">        Args:</span>
<span class="sd">            respect_wash_sales (bool): Whether to respect wash sale restrictions (default: True)</span>
<span class="sd">            preserve_targets (bool): Whether to maintain target allocations (default: True)</span>
<span class="sd">            debug (bool): Whether to print debug information (default: False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, Dict, pd.DataFrame]: Tuple containing:</span>
<span class="sd">                - Maximum withdrawal amount possible</span>
<span class="sd">                - Trade summary with optimization statistics</span>
<span class="sd">                - DataFrame of trades required to achieve the withdrawal</span>

<span class="sd">        Note:</span>
<span class="sd">            The actual withdrawal amount may be less than the total portfolio value</span>
<span class="sd">            due to various constraints like wash sales or target preservation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call the helper function to do the calculation</span>
        <span class="k">return</span> <span class="n">calculate_max_withdrawal</span><span class="p">(</span>
            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="n">respect_wash_sales</span><span class="o">=</span><span class="n">respect_wash_sales</span><span class="p">,</span>
            <span class="n">preserve_targets</span><span class="o">=</span><span class="n">preserve_targets</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="OracleStrategy.compare_drift">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.compare_drift">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare drift between current strategy and post-trade strategy.</span>

<span class="sd">        For pairs-based strategies, compares based on asset class drift instead</span>
<span class="sd">        of individual security drift.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pd.DataFrame, Dict]: Tuple containing:</span>
<span class="sd">                - DataFrame showing drift comparison for each position</span>
<span class="sd">                - Dictionary of summary statistics about drift improvement</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If post-trade strategy is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_trade_strategy&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No post-trade strategy available. Run compute_optimal_trades first.&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">generate_drift_comparison_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_trade_strategy</span><span class="p">)</span></div>


<div class="viewcode-block" id="OracleStrategy.compare_factor_model">
<a class="viewcode-back" href="../../modules/oracle_strategy.html#service.oracle_strategy.OracleStrategy.compare_factor_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_factor_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare factor model exposures between current and post-trade strategy.</span>

<span class="sd">        Only applicable for DIRECT_INDEX optimization type. Analyzes changes in</span>
<span class="sd">        factor exposures resulting from the proposed trades.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pd.DataFrame, Dict]: Tuple containing:</span>
<span class="sd">                - DataFrame showing factor exposure comparison</span>
<span class="sd">                - Dictionary of summary statistics about factor exposure improvements</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If post-trade strategy is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;post_trade_strategy&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No post-trade strategy available. Run compute_optimal_trades first.&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">generate_factor_model_comparison_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_trade_strategy</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>